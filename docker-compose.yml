version: '3.9'

services:

  # =====================================================
  # üóÑÔ∏è DATABASE - PostgreSQL
  # =====================================================
  database:

    # üî® Build l'image depuis notre Dockerfile personnalis√©
    build:
    # Racine du projet
      context: .                      
      dockerfile: docker/database/Dockerfile
    # Nom de l'image locale
    image: techshop-database:latest   
    # Nom fixe du container
    container_name: techshop-database 

    # üåç Variables d‚Äôenvironnement PostgreSQL
    environment:
      POSTGRES_DB: techshop
      POSTGRES_USER: techshop
      POSTGRES_PASSWORD: techshop

    # üîå Expose le port 5432 vers la machine locale
    ports:
      - "5432:5432"

    # üåê Connexion au r√©seau interne Docker
    networks:
      - techshop-network

    # üíæ Volume pour persister les donn√©es PostgreSQL
    volumes:
      - postgres-data:/var/lib/postgresql/data


  # =====================================================
  # üë§ USER SERVICE (Python / FastAPI)
  # =====================================================
  user-service:

    build:
      context: .
      dockerfile: docker/user-service/Dockerfile

    image: techshop-user-service:latest
    container_name: techshop-user-service

    # ‚è≥ Attendre que la base d√©marre avant
    depends_on:
      - database

    # üîó URL de connexion √† PostgreSQL
    environment:
      DATABASE_URL: postgresql://techshop:techshop@database:5432/techshop

    ports:
      - "8001:8001"

    networks:
      - techshop-network


  # =====================================================
  # üì¶ PRODUCT SERVICE (Java / Spring Boot)
  # =====================================================
  product-service:

    build:
      context: .
      dockerfile: docker/product-service/Dockerfile

    image: techshop-product-service:latest
    container_name: techshop-product-service

    depends_on:
      - database

    # üîó Configuration Spring Boot pour PostgreSQL
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://database:5432/techshop
      SPRING_DATASOURCE_USERNAME: techshop
      SPRING_DATASOURCE_PASSWORD: techshop

    ports:
      - "8002:8002"

    networks:
      - techshop-network


  # =====================================================
  # üßæ ORDER SERVICE (Go)
  # =====================================================
  order-service:

    build:
      context: .
      dockerfile: docker/order-service/Dockerfile

    image: techshop-order-service:latest
    container_name: techshop-order-service

    depends_on:
      - database

    # üîó Connexion PostgreSQL pour service Go
    environment:
      DATABASE_URL: postgres://techshop:techshop@database:5432/techshop?sslmode=disable

    ports:
      - "8003:8003"

    networks:
      - techshop-network


  # =====================================================
  # üåâ API GATEWAY (Node.js)
  # =====================================================
  api-gateway:

    build:
      context: .
      dockerfile: docker/api-gateway/Dockerfile

    image: techshop-api-gateway:latest
    container_name: techshop-api-gateway

    # ‚è≥ Attendre les microservices
    depends_on:
      - user-service
      - product-service
      - order-service

    # üîó URLs internes des microservices
    environment:
      USER_SERVICE_URL: http://user-service:8001
      PRODUCT_SERVICE_URL: http://product-service:8002
      ORDER_SERVICE_URL: http://order-service:8003

    ports:
      - "3000:3000"

    networks:
      - techshop-network


  # =====================================================
  # üñ•Ô∏è FRONTEND (React + Nginx)
  # =====================================================
  frontend:

    build:
      context: .
      dockerfile: docker/frontend/Dockerfile

    image: techshop-frontend:latest
    container_name: techshop-frontend

    depends_on:
      - api-gateway

    # üåç Expose sur le port 80 (acc√®s navigateur)
    ports:
      - "80:80"

    networks:
      - techshop-network


# =====================================================
# üåê R√âSEAU DOCKER INTERNE
# =====================================================
networks:
  techshop-network:
  # R√©seau isol√© interne Docker
    driver: bridge   


# =====================================================
# üíæ VOLUME POUR PERSISTANCE DB
# =====================================================
volumes:
  postgres-data: